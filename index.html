<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ガチャ (V.1.00)</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin-top: 50px;
      background-color: #f8f9fa;
    }

    h1 {
      font-size: 36px;
      margin-bottom: 20px;
    }

    button {
      padding: 12px 24px;
      margin: 10px;
      font-size: 20px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      transition: background-color 0.3s;
    }

    button:hover:enabled {
      background-color: #0056b3;
    }

    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }

    .result {
      margin-top: 30px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .item {
      margin: 2px;
      padding: 6px 10px;
      border-radius: 5px;
      font-size: 16px;
      opacity: 0;
      transform: scale(0.8);
      transition: all 0.3s ease;
      display: inline-block;
      color: black;
      font-weight: bold;
      user-select: none;
    }

    .item.show {
      opacity: 1;
      transform: scale(1);
    }

    .star-1  { background-color: #ddd; }
    .star-2  { background-color: #b0e0e6; }
    .star-3  { background-color: #90ee90; }
    .star-4  { background-color: #ffa500; color: white; }
    .star-5  { background-color: #ff69b4; color: white; }
    .star-6  { background-color: #ffd700; color: black; } /* 金色 */
    /* 虹色アニメーション */
    @keyframes rainbow {
      0%, 100% { color: red; }
      14% { color: orange; }
      28% { color: yellow; }
      42% { color: green; }
      56% { color: blue; }
      70% { color: indigo; }
      84% { color: violet; }
    }
    .star-7 {
      background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbow 3s linear infinite;
      font-weight: bolder;
      border-radius: 0;
      padding: 6px 8px;
      margin: 2px;
      display: inline-block;
    }

    #summaryArea {
      margin-top: 20px;
      font-size: 18px;
      white-space: normal;
      text-align: left;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
  </style>
</head>
<body>
  <h1>ガチャシステム</h1>
  <button id="btn1" onclick="rollGacha(1)">単発</button>
  <button id="btn10" onclick="rollGacha(10)">10連</button>
  <button id="btn100" onclick="rollGacha(100)">100連</button>

  <div class="result" id="resultArea"></div>
  <div id="summaryArea"></div>

  <script>
    const items = [
      "★ 猫",        // 1つ星
      "★ 犬",        // 1つ星
      "★★ 牛",       // 2つ星
      "★★ 豚",       // 2つ星
      "★★★ 鳥",      // 3つ星
      "★★★★ 人間",   // 4つ星
      "★★★★★ 不死鳥",  // 5つ星
      "★★★★★★ ドラゴン", // 6つ星
      "★★★★★★★ 神"     // 7つ星
    ];

    // 重みは合計100%
    const weights = [30, 30, 15, 15, 6.9, 2.8, 0.24, 0.05, 0.01];

    function getStarClass(itemOrStars) {
      // itemOrStarsがitem全体の場合、★だけ抽出
      let stars = itemOrStars;
      if (!/^[★]+$/.test(itemOrStars)) {
        stars = (itemOrStars.match(/★+/) || [''])[0];
      }
      const starCount = stars.length || 1;
      return 'star-' + starCount;
    }

    function rollItem() {
      const totalWeight = weights.reduce((a, b) => a + b, 0);
      let rand = Math.random() * totalWeight;
      for (let i = 0; i < items.length; i++) {
        if (rand < weights[i]) return items[i];
        rand -= weights[i];
      }
      return items[0];
    }

    function setButtonsDisabled(state) {
      document.getElementById('btn1').disabled = state;
      document.getElementById('btn10').disabled = state;
      document.getElementById('btn100').disabled = state;
    }

    let rolling = false; // ガチャ中判定

    function rollGacha(times) {
      if (rolling) return; // 実行中は無視
      rolling = true;

      const resultArea = document.getElementById('resultArea');
      const summaryArea = document.getElementById('summaryArea');
      resultArea.innerHTML = '';
      summaryArea.innerHTML = '';
      setButtonsDisabled(true);

      const results = [];
      for (let i = 0; i < times; i++) {
        results.push(rollItem());
      }

      const countByItem = {};

      let i = 0;
      function showNext() {
        if (i >= results.length) {
          // 集計表示（色付きの星だけHTMLで表示）
          summaryArea.innerHTML = '【結果集計】<br>';
          Object.entries(countByItem)
            .sort((a, b) => {
              const aStar = (a[0].match(/★/g) || []).length;
              const bStar = (b[0].match(/★/g) || []).length;
              return bStar - aStar;
            })
            .forEach(([item, count]) => {
              const starPart = (item.match(/★+/) || [''])[0];
              const namePart = item.replace(starPart, '').trim();

              const starSpan = `<span class="item ${getStarClass(starPart)}">${starPart}</span>`;
              summaryArea.innerHTML += `${starSpan} ${namePart} : ${count}個<br>`;
            });

          setButtonsDisabled(false);
          rolling = false;
          return;
        }

        const item = results[i];
        const span = document.createElement('span');
        span.className = 'item ' + getStarClass(item);
        span.textContent = item;
        resultArea.appendChild(span);

        countByItem[item] = (countByItem[item] || 0) + 1;

        // フェードイン＋拡大演出
        setTimeout(() => {
          span.classList.add('show');
        }, 10);

        i++;
        setTimeout(showNext, 40);
      }

      showNext();
    }
  </script>
</body>
</html>
